from app_base import AppBase
from utils.helpers import default
from flask_classful import route
from flask import request
import json
from VirusTotal.virustotal import VirusTotalAnalyzer
class MalwareAnalyzer(AppBase):
    def __init__(self,REDIS_URL='127.0.0.1',REDIS_PORT='6379',DB_INDEX=1):
        super().__init__(REDIS_URL,REDIS_PORT,DB_INDEX)
        self.virus_total_analyzer = VirusTotalAnalyzer()
    @route('detect',methods=['POST'])
    def run_analyzer(self):
        data = request.json
        md5_after = data["syscheck"].get("md5_after",None)
        sha1_after = data["syscheck"].get("md5_after",None)
        sha256_after = data["syscheck"].get("md5_after",None)
        result = self.virus_total_analyzer.scan_hash(sha1_after)
        db_size = self.redis_conn.dbsize()
        workflow_id = f'workflow_{db_size+1}'
        #with open(f'media/malware/{workflow_id}.json',"w") as f:
        #    f.write(json.dumps({"workflow_id":workflow_id,"data":data,"result":result}, default=default,indent=4))
        return result